<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&display=swap" rel="stylesheet">
</head>
<body onload="Load()" onkeydown="move(event)" style="text-align:center;background-color:black">
	<canvas width="900" height="600" id="canvas" onmousemove="getMousePos(event)" style="cursor:none"></canvas>
        <canvas width="1000" height="1" id="canvas2" hidden></canvas>
	<canvas width="1600" height="1600" id="canvas3"></canvas>
</body>
<script>
//non gameplay variables
var times = 0
var screen = ""
var objectMap
var seed = Math.round(Math.random()*2**24) //seed
var attackDuration = 0 //animation
var mousePos = {}
var particles = []
var click = [false, 0]
var texts = []
var projs = []
var drops = []
var enemies = []
var holding = 0
var screenBonus = [0,1,0,0,0,0,0,0]
var terrainGradient
var maxTimes = 53
var items = [
	//name: name, mindmg, maxdmg, atkspeedmult, rarity (cosmetic), toolstrength, damagemult: [ores, trees, mobs], description
	{name:"Nothing"           ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it's nothing"             },
	{name:"Balsa Wood"        ,minDamage:2 , maxDamage:3 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"softboi"                  },
	{name:"Workbench"         ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"bench"                    },
	{name:"Balsa Wall"        ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"wall"                     },
	{name:"Balsa Gate"        ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"wall but gate"            },
	{name:"Balsa Bark"        ,minDamage:0 , maxDamage:0 , atkSpeed:2   , rarity: "common", toolStrength: 0, damageMult:7, desc:"tree skin"                },
	{name:"Balsa Handle"      ,minDamage:3 , maxDamage:4 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"softboi but handle"        },
	{name:"Balsa Wood Pickaxe",minDamage:4 , maxDamage:5 , atkSpeed:0.9 , rarity: "common", toolStrength: 1, damageMult:5, desc:"it go mine"                },
	{name:"Balsa Wood Axe"    ,minDamage:5 , maxDamage:6 , atkSpeed:0.9 , rarity: "common", toolStrength: 1, damageMult:3, desc:"it go chop chop"           },
	{name:"Balsa Wood Sword"  ,minDamage:4 , maxDamage:5 , atkSpeed:1.1 , rarity: "common", toolStrength: 1, damageMult:1, desc:"it go stab"                },
	{name:"Stone"             ,minDamage:3 , maxDamage:4 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"rocc"                      },
	{name:"Stone Pickaxe"     ,minDamage:7 , maxDamage:9 , atkSpeed:0.9 , rarity: "common", toolStrength: 2, damageMult:5, desc:"it go mine"                },
	{name:"Stone Axe"         ,minDamage:9 , maxDamage:11, atkSpeed:0.9 , rarity: "common", toolStrength: 2, damageMult:3, desc:"it go chop chop"           },
	{name:"Stone Sword"       ,minDamage:7 , maxDamage:9 , atkSpeed:1.1 , rarity: "common", toolStrength: 2, damageMult:1, desc:"it go stab"                },
	{name:"Stone Wall"        ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"wall"                      },
	{name:"Stone Gate"        ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"wall but gate"             },
	{name:"Furnace"           ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it go hot"                 },
        {name:"Coal"              ,minDamage:1 , maxDamage:1 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it's black"                },
	{name:"Copper Ore"        ,minDamage:3 , maxDamage:4 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it's rock but copper"      },
	{name:"Copper Ingot"      ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it's copper but ingot"     },
	{name:"Copper Pickaxe"    ,minDamage:11, maxDamage:13, atkSpeed:0.95, rarity: "common", toolStrength: 3, damageMult:5, desc:"mine"                      },
	{name:"Copper Axe"        ,minDamage:13, maxDamage:15, atkSpeed:0.95, rarity: "common", toolStrength: 3, damageMult:3, desc:"choppy chop"               },
	{name:"Copper Sword"      ,minDamage:11, maxDamage:13, atkSpeed:1.15, rarity: "common", toolStrength: 3, damageMult:1, desc:"ow"                        },
	{name:"Copper Helmet"     ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it's upside down w"        },
	{name:"Copper Chestplate" ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it's chestplate"           },
	{name:"Copper Leggings"   ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it's upside down U"        },
	{name:"Copper Boots"      ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it's airpods"              },
	{name:"Iron Ore"          ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it's rock but iron"        },
        {name:"Iron Ingot"        ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it's iron but ingot"       },
	{name:"Copper Wall"       ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"you can't walk through it" },
	{name:"Copper Gate"       ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"you can walk through it"   },
	{name:"Anvil"             ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"iron block"                },
	{name:"Iron Pickaxe"      ,minDamage:20, maxDamage:28, atkSpeed:1   , rarity: "common", toolStrength: 4, damageMult:5, desc:"you can mine diamonds!"    },
	{name:"Iron Axe"          ,minDamage:23, maxDamage:30, atkSpeed:1   , rarity: "common", toolStrength: 4, damageMult:3, desc:"you can chop red trees"    },
	{name:"Iron Sword"        ,minDamage:20, maxDamage:28, atkSpeed:1.2 , rarity: "common", toolStrength: 4, damageMult:1, desc:"looks more like a knife"   },
	{name:"Iron Helmet"       ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"w but upside down"         },
	{name:"Iron Chestplate"   ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it's chestplate"           },
	{name:"Iron Leggings"     ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"U but upside down"         },
	{name:"Iron Boots"        ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"airpods+"                  },
	{name:"Iron Wall"         ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"stone wall+"               },
	{name:"Iron Gate"         ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"stone gate+"               },
	{name:"Steel Ingot"       ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"iron ingot but better"     },
	{name:"Wood Chest"        ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it can store things"       },
	{name:"Steel Pickaxe"     ,minDamage:32, maxDamage:42, atkSpeed:1.04, rarity: "common", toolStrength: 5, damageMult:5, desc:"iron pickaxe but better"   },
	{name:"Steel Axe"         ,minDamage:38, maxDamage:51, atkSpeed:1.04, rarity: "common", toolStrength: 5, damageMult:3, desc:"iron axe but better"       },
	{name:"Steel Sword"       ,minDamage:32, maxDamage:42, atkSpeed:1.23, rarity: "common", toolStrength: 5, damageMult:1, desc:"looks like an actual knife"},
	{name:"Steel Helmet"      ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it's still upside down w"  },
	{name:"Steel Chestplate"  ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it's still chestplate"     },
	{name:"Steel Leggings"    ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it's still upside down U"  },
	{name:"Steel Boots"       ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"it looks like airpods"     },
	{name:"Steel Wall"        ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"iron wall but steel"       },
	{name:"Steel Gate"        ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"steel wall but gate"       },
	{name:"Steel Chest"       ,minDamage:2 , maxDamage:2 , atkSpeed:1   , rarity: "common", toolStrength: 0, damageMult:7, desc:"more storage because steel"},
]
var unlocked = Array(items.length).fill(false)
var recipes = [
        [   [[1 , 4 ]                    ] , [16, 0] , [2 , 1]  ], //workbench
	[   [[1 , 1 ]                    ] , [16   ] , [5 , 2]  ], //make bark
	[   [[1 , 2 ]                    ] , [16   ] , [6 , 1]  ], //balsa handle
	[   [[1 , 6 ]                    ] , [16   ] , [3 , 1]  ], //balsa wall
	[   [[1 , 6 ]                    ] , [16   ] , [4 , 1]  ], //balsa gate
	[   [[6 , 1 ] , [1 , 4] , [5 , 3]] , [16   ] , [7 , 1]  ], //balsa pick
	[   [[6 , 1 ] , [1 , 4] , [5 , 3]] , [16   ] , [8 , 1]  ], //balsa axe
	[   [[6 , 1 ] , [1 , 3] , [5 , 3]] , [16   ] , [9 , 1]  ], //balsa sword
	[   [[6 , 1 ] , [10, 5] , [5 , 3]] , [16   ] , [11, 1]  ], //stone pick
	[   [[6 , 1 ] , [10, 5] , [5 , 3]] , [16   ] , [12, 1]  ], //stone axe
	[   [[6 , 1 ] , [10, 4] , [5 , 3]] , [16   ] , [13, 1]  ], //stone sword
	[   [[10, 6 ]                    ] , [16   ] , [14, 1]  ], //stone wall
	[   [[10, 6 ]                    ] , [16   ] , [15, 1]  ], //stone gate
	[   [[10, 10]                    ] , [16   ] , [16, 1]  ], //furnace
	[   [[1 , 1 ]                    ] , [21   ] , [17, 1]  ], //coal
	[   [[18, 1 ] , [17, 2]          ] , [21   ] , [19, 1]  ], //copper ingot
	[   [[6 , 1 ] , [19, 6] , [5 , 3]] , [16   ] , [20, 1]  ], //copper pick
	[   [[6 , 1 ] , [19, 6] , [5 , 3]] , [16   ] , [21, 1]  ], //copper axe
	[   [[6 , 1 ] , [19, 5] , [5 , 3]] , [16   ] , [22, 1]  ], //copper sword
	[   [[19, 5 ]                    ] , [22   ] , [23, 1]  ], //copper helm
	[   [[19, 15]                    ] , [22   ] , [24, 1]  ], //chestplate
	[   [[19, 10]                    ] , [22   ] , [25, 1]  ], //leggings
	[   [[19, 5 ]                    ] , [22   ] , [26, 1]  ], //boots
	[   [[27, 1 ] , [17, 2]          ] , [21   ] , [28, 1]  ], //iron ingot
	[   [[19, 6 ]                    ] , [22   ] , [29, 1]  ], //copper wall
	[   [[19, 6 ]                    ] , [22   ] , [30, 1]  ], //copper gate
	[   [[28, 9 ]                    ] , [16   ] , [31, 1]  ], //anvil
	[   [[6 , 1 ] , [28, 7]          ] , [22   ] , [32, 1]  ], //iron pick
	[   [[6 , 1 ] , [28, 7]          ] , [22   ] , [33, 1]  ], //iron axe
	[   [[6 , 1 ] , [28, 6]          ] , [22   ] , [34, 1]  ], //iron sword
	[   [[28, 5 ]                    ] , [22   ] , [35, 1]  ], //iron helm
	[   [[28, 15]                    ] , [22   ] , [36, 1]  ], //iron chestplate
	[   [[28, 10]                    ] , [22   ] , [37, 1]  ], //iron leggings
	[   [[28, 5 ]                    ] , [22   ] , [38, 1]  ], //iron boots
	[   [[28, 6 ]                    ] , [22   ] , [39, 1]  ], //rion wall
	[   [[28, 6 ]                    ] , [22   ] , [40, 1]  ], //iron gate
	[   [[28, 3 ] , [17, 5]          ] , [21   ] , [41, 1]  ], //steel ingot
	[   [[1 , 12] , [10, 6]          ] , [16   ] , [42, 1]  ], //chest
	[   [[32, 1 ] , [41, 5]          ] , [22   ] , [43, 1]  ], //steel pick
	[   [[33, 1 ] , [41, 7]          ] , [22   ] , [44, 1]  ], //steel axe
	[   [[34, 1 ] , [41, 7]          ] , [22   ] , [45, 1]  ], //steel sword
	[   [[41, 3 ] , [35, 1]          ] , [22   ] , [46, 1]  ], //iron helm
	[   [[41, 4 ] , [35, 1]          ] , [22   ] , [47, 1]  ], //iron chestplate
	[   [[41, 3 ] , [35, 1]          ] , [22   ] , [48, 1]  ], //iron leggings
	[   [[41, 2 ] , [35, 1]          ] , [22   ] , [49, 1]  ], //iron boots
	[   [[41, 6 ]                    ] , [22   ] , [50, 1]  ], //steel wall
	[   [[41, 6 ]                    ] , [22   ] , [51, 1]  ], //steel gate
	[   [[28, 8] , [41, 4]           ] , [16   ] , [52, 1]  ], //steel chest
]
var inventory = [
	[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],
	[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],
	[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],
	[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],
	[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],
	[0, 0, 0, 0]
]
var lootTables = [
	[],
        [[1 , 3, 5]                      ], //balsa
	[[10, 3, 5]                      ], //stone
	[[18, 2, 3], [10, 80], [10, 100] ], //copper ore
	[[27, 2, 3], [10, 80], [10, 100] ], //iron ore
	[], //maple
	[], //platinum
	[], //mithril
	[], //birch
	[], //adamantite
	[], //titanium
	[], //pine
	[], //unobtain
	[], //uni
	[[3 , 1, 1]                      ], //wood wall
	[[4 , 1, 1]                      ], //wood gate
	[[2 , 1, 1]                      ], //bench
	[[14, 1, 1]                      ], //stone wall
	[[15, 1, 1]                      ], //stone gate
	[[29, 1, 1]                      ], //copper wall
	[[30, 1, 1]                      ], //copper gate
	[[16, 1, 1]                      ], //furnace
	[[31, 1, 1]                      ], //anvil
	[[39, 1, 1]                      ], //iron wall
	[[40, 1, 1]                      ], //iron gate
	[[42, 1, 1]                      ], //chest
	[[52, 1, 1]                      ], //steel chest
	[[50, 1, 1]                      ], //steel wall
	[[51, 1, 1]                      ], //steel gate
]
var out = [0,0]
var toolStrengthReq = [0, 
0, 1, 2, 3, 4, 
4, 5, 6, 6, 7,
8, 8, 9, 0, 0,
0, 1, 1, 2, 2,
1, 3, 3, 3, 1,
4, 4, 4
]
var objectHP =  [0, 
        10  , 25  , 40   , 75  , 250 , 
	300 , 1000 , 750  , 2500, 6969, 
	13579, 22222, 314159, 50  , 25  ,
	75  , 100 , 50  , 200 , 100 , 
	125 , 250 , 400 , 200 , 50  ,
	500 , 600 , 300 , 30
]
var player = {
	pos: [],
	stats: {
                climbPower: 0.04,
		hp: 100,
		mhp: 100,
		stamina: 100,
		staminaCMult:1,
		defense: 0,
		attackSpeed: 1,
		reach: 40,
		critChance: 5,
		critDamage: 140,
		inventorySlots: 14,
		regen: 0,
	},
	exp: 0,
	level: 0,
	attackCooldown: 0,
	powerups: {
		dumbbell: 0,
		box: 0,
		rock: 0,
		milk1: 0, //chocy milk
		milk2: 0, //milk
		glove: 0,
		clover1: 0, //4 leaf
		taser: 0,
		tooth: 0,
		milk3: 0, //soy milk
		pill: 0,
		potion: 0,
		foot: 0,
		quiver: 0, 
		drive: 0,
		berserk: 0,
		berserkActive:0, //not a powerup
		book: 0,
		clover2: 0, //5-leaf
		ruby: 0,
		rubyPower: 0, //not a powerup 2
	},
}
function calculateDamage() {
	var dmgMult = 1 , crit = 0
	if (Math.random() < (player.powerups.clover2**0.6)/100) {
		dmgMult *= Math.log(player.powerups.clover2)*15;crit=2
	}
	if(Math.random() < player.stats.critChance/100) {
		dmgMult *= player.stats.critDamage/100+1;crit=1
	} //crit
	dmgMult *= player.powerups.dumbbell*0.04+1
	var i = items[inventory[holding][0]] //item (base damage)
        updateStats()
        return [Math.round(randomRange(i.minDamage, i.maxDamage)*dmgMult),crit]
	update()
}
function updateStats() {
	var baseStats = {
                climbPower: 0.04,
		hp: player.stats.hp,
		mhp: 100,
		stamina: player.stats.stamina,
		staminaCMult: 1,
		defense: 0,
		attackSpeed: 1,
		reach: 40,
		critChance: 5,
		critDamage: 140,
		inventorySlots: 14,
		regen: 0,
	}
	//drive
	var b = []
	b[0] = player.stats.hp/player.stats.mhp<player.powerups.drive/(10+player.powerups.drive) ? player.powerups.drive**0.4 : 0
	//berserk
        b[1] = player.powerups.berserkActive>0?Math.log(player.powerups.berserk):0
	//ruby
	b[2] = player.powerups.rubyPower
	baseStats.defense        += 0 //from armor
	baseStats.inventorySlots += player.powerups.box*2
	baseStats.critDamage     += player.powerups.rock*8+b[1]*2
	baseStats.attackSpeed    += player.powerups.milk1*0.045+b[1]/2
	baseStats.defense        *= player.powerups.milk2*0.05+b[2]/100+1
	baseStats.reach          += player.powerups.glove*4
	baseStats.critChance     += player.powerups.clover1*10+b[2]/1000
	baseStats.staminaCMult   *= 3/(player.powerups.milk3+3)*10000/(b[2]+10000)
        baseStats.mhp            += player.powerups.pill*20+b[2]
	baseStats.climbPower     += player.powerups.foot*0.02
	baseStats.regen          += player.powerups.potion*0.1
        //boosts
	baseStats.defense *= b[0]+1
	baseStats.critDamage *= b[0]/1.4+1
	baseStats.attackSpeed *= b[0]/3+1
	baseStats.reach += b[0]*1.3+1
	baseStats.critChance += b[0]+1
	baseStats.staminaCMult /= b[0]/2+1
	baseStats.regen *= b[0]+1
	baseStats.hp = Math.min(baseStats.regen+baseStats.hp,baseStats.mhp)
	player.stats = baseStats
}
function attack() {
	var rotation = -Math.atan2(mousePos.x-450,mousePos.y-330)+Math.PI 
	var x = -9
	while (x<=9) {
		var y = -9
		while (y<=9) {
                        if (circleCollision(player.pos[0]+0.5+51/60*Math.sin(rotation), player.pos[1]+0.5-51/60*Math.cos(rotation), player.stats.reach/60, player.pos[0]+0.5+x, player.pos[1]+0.5+y, Math.SQRT1_2)) {
                                var damage = calculateDamage()
				var x2 = Math.min(Math.max(player.pos[0]+x,0),map.length-1)
				var y2 = Math.min(Math.max(player.pos[1]+y,0),map.length-1)
				if (items[inventory[holding][0]].toolStrength >= toolStrengthReq[objectMap[x2][y2][0]]) {
                                        damage[0] = Math.round(damage[0]*1.1**(items[inventory[holding][0]].toolStrength-toolStrengthReq[objectMap[x2][y2][0]]))                                
					objectMap[x2][y2][1] -= damage[0]
				} else {
					damage[0] = 0
				}
				var rot = Math.atan2(x,y)
				player.exp += damage[0]           
				switch (objectMap[x2][y2][0]) {
					case 1: 
					        createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],rot-0.7,rot+0.7,0.1,0.141,[92,66,8,255],"rgb",0.1,0.13,4,8,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],-0.4,0.4,0.1,0.141,[92,66,8,255],"rgb",0.1,0.13,2,3,23,26,0.86,0.89)
						createParticles(x2,0.1+y2,1+x2,0.45+y2,[1,2],[0.005,2],-1,1,0.03,0.05,[106,190,48,255],"rgb",0.1,0.13,6,8,100,140,0.94,0.96)
					break;//tree
					case 2: //rocc
					case 17: //stone wall
					case 18: //stone gate
					case 21: //furnace
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],rot-0.7,rot+0.7,0.1,0.141,[100,100,108,255],"rgb",0.1,0.13,4,8,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],-0.4,0.4,0.1,0.141,[100,100,108,255],"rgb",0.1,0.13,2,3,23,26,0.86,0.89)
					break;
					case 3:
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],rot-0.7,rot+0.7,0.1,0.141,[100,100,108,255],"rgb",0.1,0.13,3,5,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],-0.4,0.4,0.1,0.141,[100,100,108,255],"rgb",0.1,0.13,1,2,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],rot-0.7,rot+0.7,0.1,0.141,[185,122,87,255],"rgb",0.1,0.13,1,3,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],-0.4,0.4,0.1,0.141,[185,122,87,255],"rgb",0.1,0.13,1,1,23,26,0.86,0.89)
					break;//copper ore
					case 4:
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],rot-0.7,rot+0.7,0.1,0.141,[100,100,108,255],"rgb",0.1,0.13,3,5,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],-0.4,0.4,0.1,0.141,[100,100,108,255],"rgb",0.1,0.13,1,2,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],rot-0.7,rot+0.7,0.1,0.141,[160,129,112,255],"rgb",0.1,0.13,1,3,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],-0.4,0.4,0.1,0.141,[160,129,112,255],"rgb",0.1,0.13,1,1,23,26,0.86,0.89)
					break;//iron ore
					case 14: //wood wall
					case 15: //wood gate
					case 16: //workbench
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],rot-0.7,rot+0.7,0.1,0.141,[92,66,8,255],"rgb",0.1,0.13,4,8,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],-0.4,0.4,0.1,0.141,[92,66,8,255],"rgb",0.1,0.13,2,3,23,26,0.86,0.89)
					break;
					case 19: //copper wall
					case 20: //copper gate
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],rot-0.7,rot+0.7,0.1,0.141,[185,122,87,255],"rgb",0.1,0.13,4,8,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],-0.4,0.4,0.1,0.141,[185,122,87,255],"rgb",0.1,0.13,2,3,23,26,0.86,0.89)
					break;
					case 22: //anvil
					case 23: //iron wall
					case 24: //iron gate
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],rot-0.7,rot+0.7,0.1,0.141,[146,136,133,255],"rgb",0.1,0.13,4,8,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],-0.4,0.4,0.1,0.141,[146,136,133,255],"rgb",0.1,0.13,2,3,23,26,0.86,0.89)
					break;
					case 25: //wood chest
                                                createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],rot-0.7,rot+0.7,0.1,0.141,[92,66,8,255],"rgb",0.1,0.13,4,8,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],-0.4,0.4,0.1,0.141,[92,66,8,255],"rgb",0.1,0.13,2,3,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],rot-0.7,rot+0.7,0.1,0.141,[100,100,108,255],"rgb",0.1,0.13,4,8,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],-0.4,0.4,0.1,0.141,[100,100,108,255],"rgb",0.1,0.13,2,3,23,26,0.86,0.89)
					break;
					case 26: //steel chest
					        createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],rot-0.7,rot+0.7,0.1,0.141,[146,136,133,255],"rgb",0.1,0.13,4,8,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],-0.4,0.4,0.1,0.141,[146,136,133,255],"rgb",0.1,0.13,2,3,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],rot-0.7,rot+0.7,0.1,0.141,[213,207,206,255],"rgb",0.1,0.13,4,8,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],-0.4,0.4,0.1,0.141,[213,207,206,255],"rgb",0.1,0.13,2,3,23,26,0.86,0.89)
					break;
					case 27: //steel wall
					case 28: //steel gate
					        createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],rot-0.7,rot+0.7,0.1,0.141,[213,207,206,255],"rgb",0.1,0.13,4,8,23,26,0.86,0.89)
						createParticles(0.45+x2,0.45+y2,0.55+x2,0.55+y2,[1,2],[0.005,10],-0.4,0.4,0.1,0.141,[213,207,206,255],"rgb",0.1,0.13,2,3,23,26,0.86,0.89)
					break;
				}
				if (objectMap[x2][y2][0] > 0) {
					switch (damage[1]) {
						case 0:
                                                        texts.push({
                                                                x: x2+0.5,
					                        y: y2+0.5,
					                        dx: Math.random()/5-0.1,
					                        dy: 0.15,
					                        fadeSpeed: 8,
					                        color: [255, 255, 255, 255],
					                        content: damage[0],
				                        })
						break;
						case 1:
                                                        texts.push({
                                                                x: x2+0.5,
					                        y: y2+0.5,
					                        dx: Math.random()/5-0.1,
					                        dy: 0.15,
					                        fadeSpeed: 8,
					                        color: [255, 255, 0, 255],
					                        content: damage[0],
				                        })
						break;
						case 2:
                                                        texts.push({
                                                                x: x2+0.5,
					                        y: y2+0.5,
					                        dx: Math.random()/5-0.1,
					                        dy: 0.15,
					                        fadeSpeed: 8,
					                        color: [255, 0, 0, 255],
					                        content: damage[0],
				                        })
						break;
					}
				}			    
			}  
			y++
		}
		x++
	}
	for (x in enemies) {
		var coll = circleCollision(player.pos[0]+0.5+51/60*Math.sin(rotation), player.pos[1]+0.5-51/60*Math.cos(rotation), player.stats.reach/60
		,enemies[x].x+0.5,enemies[x].y+0.5,Math.SQRT1_2)
		if (coll) {
                        var particleRad = Math.atan2(player.pos[0]-enemies[x].x, player.pos[1]-enemies[x].y)+Math.PI
			createParticles(0.45+enemies[x].x,0.45+enemies[x].y,0.55+enemies[x].x,0.55+enemies[x].y,[1,2],[0.005,10],-0.7+particleRad,0.7+particleRad,0.06,0.1,[255,0,0,255],"rgb",0.1,0.13,3,5,40,50,0.97,0.98)
			createParticles(0.45+enemies[x].x,0.45+enemies[x].y,0.55+enemies[x].x,0.55+enemies[x].y,[1,2],[0.005,10],-0.7+particleRad,0.7+particleRad,0.06,0.1,[200,0,0,255],"rgb",0.1,0.13,3,5,40,50,0.97,0.98)
		        var damage = calculateDamage()
			player.exp += 5*damage[0]*((items[inventory[holding][0]].damageMult/(1<<0))%2<<0)
			switch (damage[1]) {
				case 0:
                                        texts.push({
                                                x: x2+0.5,
					                y: y2+0.5,
					                dx: Math.random()/5-0.1,
					                dy: 0.15,
					                fadeSpeed: 8,
					                color: [255, 255, 255, 255],
					                content: damage[0],
				                })
				break;
				case 1:
                                        texts.push({
                                                x: x2+0.5,
					        y: y2+0.5,
					        dx: Math.random()/5-0.1,
					        dy: 0.15,
					        fadeSpeed: 8,
					        color: [255, 255, 0, 255],
					        content: damage[0],
				        })
				break;
				case 2:
                                        texts.push({
                                                x: x2+0.5,
					        y: y2+0.5,
					        dx: Math.random()/5-0.1,
					        dy: 0.15,
					        fadeSpeed: 8,
					        color: [255, 0, 0, 255],
					        content: damage[0],
				        })
				break;
			}		        
		        enemies[x].hp -= damage[0]*((items[inventory[holding][0]].damageMult/(1<<0))%2<<0)
		}
	}
}
function update() {
	if (times>maxTimes&&player.stats.hp>0) {
		var x=-40,c
	        while (x <= 40) {
		        var y = -40
		        while (y <= 40) {
		        	var x2 = Math.min(Math.max(player.pos[0] + x, 0), map.length-1), y2 = Math.min(Math.max(player.pos[1] + y, 0), map[0].length-1)                          
				if (objectMap[x2][y2][1] <= 0&&objectMap[x2][y2][0]) {
                                        spawnItems(lootTables[objectMap[x2][y2][0]], 1, x2+0.5, y2+0.5)
					switch (objectMap[x2][y2][0]) {
                                                case 25: //normal chest
						        var a
						        for (a in objectMap[x2][y2][3].storage) {
							        var rad = Math.random()*Math.PI*2
			                                        var speed = Math.random()*0.1
								var loot = objectMap[x2][y2][3].storage[a]
			                                        drops.push({
				                                        id: loot[0],
				                                        x: x+0.5,
				                                        y: y+0.5,
				                                        dx: Math.sin(rad)*speed,
				                                        dy: Math.cos(rad)*speed,
				                                        friction: 0.97,
				                                        amount: 1,
				                                        life: loot[1], 
			                                        })
						        }
						break;
					}
                                        objectMap[x2][y2] = [0,0,0,{}]
				}
		        	y++
		        }
		        x++
	        }
		updateStats()
		updateTime()
		updateInventory()
		updateClick()
		for (x in enemies) {
			enemies[x].tick()
		}
		if (click[0]) pickup("inventory")
                player.stats.stamina=Math.min(player.stats.stamina+0.25,100)
		player.attackCooldown < 100 ? player.attackCooldown+=player.stats.attackSpeed*items[inventory[holding][0]].atkSpeed : 0
		//console.log((!!mouseDown[0])&&(player.attackCooldown>=100)&&aa)
		if ((!!mouseDown[0])&&(player.attackCooldown>=100)&&screen=="") {
			player.attackCooldown %= 100
			attackDuration = 5	
			attack()
		}
	        render()   
	} else if (times>maxTimes) {
		alert("yuo ded \n reload for new world")
	}
}
function spawnObject() {
	spwn = [Math.round(Math.random()*(map.length-2)),Math.round(Math.random()*(map[0].length-2))]
	var dist = Math.abs(player.pos[0]-spwn[0])+Math.abs(player.pos[1]-spwn[1])
	var a = 0
	var toSpawn = parseInt(weighted_random({
		"1": 4,
		"2": 3,
		"3": 2,
	}))
	var hp = objectHP[toSpawn]
	while ((dist<25||dist>250||objectMap[spwn[0]][spwn[1]][0]!=0||map[spwn[0]][spwn[1]]<0.3)&&a<100) {
                spwn = [Math.round(Math.random()*(map.length-2)),Math.round(Math.random()*(map[0].length-2))]
		dist = Math.abs(player.pos[0]-spwn[0])+Math.abs(player.pos[1]-spwn[1])
		a++
	}
	a<100 ? objectMap[spwn[0]][spwn[1]] = [toSpawn,hp,hp,{}] : 0
}
function render() {
	renderObjects()
	build()
	for (p in drops) {
		ctx.drawImage(sprite.items,drops[p].id%5*60, Math.floor(drops[p].id/5)*60, 60, 60, (drops[p].x-player.pos[0]+20/3)*60, (drops[p].y-player.pos[1]+14/3)*60, 40, 40)
		drops[p].x += drops[p].dx
		drops[p].y += drops[p].dy
		drops[p].dx *= drops[p].friction; drops[p].dy *= drops[p].friction
		drops[p].life--
		var rarities = ["common","uncommon","rare", "epic", "legendary", "mythical"]
		var pRC = {
			"common": [230, 230, 230, 100],
			"uncommon": [0, 127, 0, 100],
			"rare": [0, 0, 166, 100],
			"epic": [157, 30, 157, 100],
			"mythical": [145, 0, 0, 100],
		}
		if (Math.random()<0.01*2**rarities.indexOf(items[drops[p].id].rarity)) {
		        createParticles(drops[p].x, drops[p].y, drops[p].x, drops[p].y,
		        [2,0], [5,0.0025], 0, Math.PI*2, 0.03, 0.05, pRC[items[drops[p].id].rarity], 
		        "rgb", 0.003, 0.003, 1, 
		        1.5**rarities.indexOf(items[drops[p].id].rarity), 
		        20, 20, 0.98, 0.98)
		}
		if (Boolean(circleCollision(drops[p].x,drops[p].y,1/3*Math.SQRT2,player.pos[0]+0.5,player.pos[1]+0.5,Math.SQRT1_2))&&drops[p].life<=0) {
			var j
			for (j in inventory) {
				if (inventory[j][0] == drops[p].id) {
					inventory[j][1] += drops[p].amount
					drops[p].x = -100
					break;
				}
				else if (inventory[j][0] == 0) {
					inventory[j][1] += drops[p].amount
					inventory[j][0] = drops[p].id
					drops[p].x = -100
					break;
				}
                                if (j >= Math.min(34,player.stats.inventorySlots-1)) break;
			}
		}
	} 
	for (p in particles) {
		var e = 0
		while (e < particles[p].type.length) {
                        switch (particles[p].type[e]) {
		        	case 0: particles[p].radius  +=                                  particles[p].amp[e]   ;break;//grow
		        	case 1: particles[p].radius   = Math.max(particles[p].radius   - particles[p].amp[e],0);break;//shrink
				case 2: particles[p].color[3] = particles[p].color[3] - particles[p].amp[e];break;//fade
		        }
			e++
	        }
		ctx.beginPath()
		ctx.fillStyle = particles[p].colorType+"a("+particles[p].color[0]+","+particles[p].color[1]+","+particles[p].color[2]+","+particles[p].color[3]/255+")"
		ctx.arc((particles[p].x-player.pos[0]+7)*60,(particles[p].y-player.pos[1]+5)*60, particles[p].radius*60, 0, 7)
		ctx.fill()
		ctx.closePath()
		particles[p].x += particles[p].dx; particles[p].y += particles[p].dy
		particles[p].dx *= particles[p].friction; particles[p].dy *= particles[p].friction
		particles[p].life--
	}
	for (p in texts) {
		//var timeExisted = (255-texts[p].color[3])/texts[p].fadeSpeed
		ctx.fillStyle = "rgba("+texts[p].color[0]+","+texts[p].color[1]+","+texts[p].color[2]+","+texts[p].color[3]/255+")"
		texts[p].color[3] -= texts[p].fadeSpeed
		texts[p].y -= texts[p].dy
		texts[p].x += texts[p].dx
		texts[p].dy -= 0.01
		ctx.fillText(texts[p].content, (texts[p].x-player.pos[0]+7)*60, (texts[p].y-player.pos[1]+5)*60)
	}
	var p,q //for loops
	ctx.translate(450,330)
	ctx.rotate(-Math.atan2(mousePos.x-450,mousePos.y-330)+Math.PI)
	/*ctx.beginPath();var s = ((mousePos.x-450)**2+(mousePos.y-330)**2)**0.5;ctx.moveTo(x3+450,y3+330);ctx.lineTo(450+x3*2,330+y3*2);ctx.stroke();ctx.closePath() ;ctx.strokeStyle="#000000"*/
	//ctx.beginPath();ctx.arc(-1,-31,player.stats.reach,0,7);ctx.strokeStyle="#ff0000";ctx.stroke();ctx.closePath()
	ctx.drawImage(sprite.player,-30,-30)
	//ctx.fillStyle = "#ff0"
	//ctx.lineWidth = 2
	///ctx.beginPath()
	//ctx.arc(450,330,30,0,7)
	//ctx.fill()
	//ctx.stroke()
	//ctx.closePath()
	ctx.setTransform(1,0,0,1,0,0)
	//ctx.beginPath()
	//ctx.arc(450+51*Math.sin(-Math.atan2(mousePos.x-450,mousePos.y-330)+Math.PI),330-51*Math.cos(-Math.atan2(mousePos.x-450,mousePos.y-330)+Math.PI),player.stats.reach,0,7)
	//ctx.stroke()
	//ctx.closePath()
	//filter off things
	drops = drops.filter(a => a.x>-1)
	particles = particles.filter(a=>a.life>0)
	texts = texts.filter(a=>a.color[3]>0)
	ctx.fillStyle = "hsla(0,0%,0%,"+(1-(Math.cos(hr*Math.PI/12+Math.PI)+1.1)/2.1)+")"
	ctx.fillRect(-900,-600,1800,1200)
	ctx.fillStyle = "white";ctx.font = "21px Roboto";ctx.textAlign = "center"
	ctx.fillText(player.pos[0]+", "+player.pos[1],40,40)
	var a = Math.floor((hr%1*60)).toString().length<2?"0"+Math.floor(hr%1*60):Math.floor(hr%1*60)
	ctx.fillText(Math.floor(hr)+":"+a,120,40) 
	renderBars()
	renderScreen()
	ctx.font = "19px Roboto"
	ctx.textAlign = "center"
	renderInventory()
	renderCursor()
}
function aaa() {
	var a=0
	var ctx3 = document.getElementById("canvas3").getContext("2d")
	while (a<map.length) {
		var b=0
		while (b<map.length) {
			var h = map[a][b]
			if (h< .1)ctx3.fillStyle="hsl(192, 100%, 15%)"
	                else if (h< .2)ctx3.fillStyle="hsl(192, 100%, 30%)"
	                else if (h< .3)ctx3.fillStyle="hsl(192, 100%, 50%)"
	                else if (h< .4)ctx3.fillStyle="hsl(62 , 100%, 45%)"
	                else if (h<.62)ctx3.fillStyle="hsl(120, 100%, 30%)"
	                else if (h<.71)ctx3.fillStyle="hsl(120 ,100%, 15%)"
	                else if (h<.75)ctx3.fillStyle="hsl(30 ,   0%, 40%)"
	                else ctx3.fillStyle="hsl(0  ,   0%, 90%)" 
	               // var pxl = document.getElementById("canvas2").getContext("2d").getImageData(Math.trunc(map[a][b]*1000),0,1,1).data
	                //ctx3.fillStyle = "rgb("+pxl[0]+","+pxl[1]+","+pxl[2]+")"
			ctx3.fillRect(b,a,1,1)
			b+=2
		}
		a+=2
	}
}
//semi-stationary functions/variables
var rarity_colors = {
	"common":"rgba(230, 230, 230, 0.6)",
	"uncommon": "rgba(0, 127, 0, 0.6)",
	"rare": "rgba(0, 0, 166, 0.6)",
	"epic": "rgba(157, 30, 157, 0.6)",
	"mythical": "rgba(190, 0, 0, 0.6)",
}
var mouseDown = [0, 0, 0, 0, 0, 0, 0, 0, 0],mouseDownCount = 0;
var map //height map
var heatMap //heat map
var canvas = document.getElementById("canvas")
var ctx = canvas.getContext("2d") //rendering
var avg = 5 //how many times times to avg-ing (5 meaning set to avg every 5 updates)
var max=0,min=0,heatMax=0,heatMin=0 //kinda useless (dont delete)
var width = 200,height = 200 //width and height of map
var day = 0
var hr = 6
var diff = 1
var sprite = {
	player: new Image(),
	object: new Image(),
	rick: new Image(), 
	items: new Image(),
	enemies: new Image(),
}
ctx.textAlign = "center"
ctx.textBaseline = "middle"
sprite.player.src = "player.png"
sprite.object.src = "object.png"
sprite.rick.src = "rick.png"
sprite.items.src = "items.png"
sprite.enemies.src = "enemies.png"
function spawnItems(lootTable, times, x, y) {
	var loots = [],a,c=0
	//loottable format: [id n, chance n] or [id n, min n, max n]
	while (c < times) {
	        for (a in lootTable) {
		        switch (lootTable[a].length) {
			        case 2:
                                        if (Math.random()<lootTable[a][1]/100) {
				        	loots.push( [lootTable[a][0], 1] )
			        	}
		        	break;
		        	case 3:
			        	loots.push( [lootTable[a][0], Math.round(randomRange(lootTable[a][1], lootTable[a][2]))] )
		        	break;
	        	}
        	}
		c++
        }
	for (a in loots) {
		var b = 0
		while (b < loots[a][1]) {
			var rad = Math.random()*Math.PI*2
			var speed = Math.random()*0.1
			drops.push({
				id: loots[a][0],
				x: x+0.5,
				y: y+0.5,
				dx: Math.sin(rad)*speed,
				dy: Math.cos(rad)*speed,
				friction: 0.97,
				amount: 1,
				life: 7, 
			})
			b++
		}
	}
}
function move(e) {
	var key = e.which || e.keyCode
	var dir = [0,0]
	switch (key) {
                case 87 : case 119: dir[1]--;break; //w
		case 65 : case 97 : dir[0]--;break; //a
		case 83 : case 115: dir[1]++;break; //s
		case 68 : case 100: dir[0]++;break; //d
		case 49 :             holding = 0; player.attackCooldown = 0;break; //1
		case 50 :             holding = 1; player.attackCooldown = 0;break;
		case 51 :             holding = 2; player.attackCooldown = 0;break;
		case 52 :             holding = 3; player.attackCooldown = 0;break;
		case 53 :             holding = 4; player.attackCooldown = 0;break; //to
		case 54 :             holding = 5; player.attackCooldown = 0;break;
		case 55 :             holding = 6; player.attackCooldown = 0;break;
		case 56 :             holding = 7; player.attackCooldown = 0;break;
		case 57 :             holding = 8; player.attackCooldown = 0;break; //9
		case 69 : case 101: screen=="inventory"?screen="":screen="inventory";break; //e
		case 82 : case 114: if (screen=="crafting") {
			screen="";screenBonus[0]=0;screenBonus[1]=1
		} else {
			screen="crafting";screenBonus[0]=0;screenBonus[1]=1
		} //r
		break;
		//case 45: screenBonus[2]=Math.max(0,screenBonus[2]-1);break;//-
		//case 61: screenBonus[2]++;break;//+
		//case 37: screenBonus[1]--;break;//left arrow
		//case 39: screenBonus[1]++;break; //right arrow
		case 27: screen="";screenBonus[0]=0;screenBonus[1]=0;break;
	}
	var x2 = player.pos[0]+dir[0]
	var y2 = player.pos[1]+dir[1]
	/*if (JSON.stringify(dir)!="[0,0]"&&player.stats.stamina>=5&&==0) {
                if ( Math.random() < 1 - 
	        Math.min(Math.abs( map[player.pos[0]][player.pos[1]] - map[player.pos[0]+dir[0]][player.pos[1]+dir[1]] ) 
	        - player.stats.test, player.stats.test*2)/player.stats.test - Math.max( 0.3-map[player.pos[0]+dir[0]][player.pos[1]+dir[1]], 0 )*1.3
	        ) {
		        player.pos[0] += dir[0]
		        player.pos[1] += dir[1]
	        }
		player.stats.stamina-=5
	} //very fun to read i know */
	if (JSON.stringify(dir)!="[0,0]") {
		switch (objectMap[x2][y2][0]) {
			case 0:
			case 15:
			case 18:
			case 20:
				if (player.stats.stamina>=5) {
				        if (Math.random()<1-Math.min(Math.abs(map[player.pos[0]][player.pos[1]]-map[x2][y2])-player.stats.climbPower, player.stats.climbPower*2)/player.stats.climbPower-Math.max(0.3-map[x2][y2],0)*1.3) {
		                                player.pos[0] += dir[0]
		                                player.pos[1] += dir[1]
	                                }
		                        player.stats.stamina-=5*player.stats.staminaCMult
			        }
			break;
			case 16:
				screen = "crafting"
				screenBonus[0] = 16
			break;
			case 21:
				screen = "crafting"
				screenBonus[0] = 21
			break;
			case 25: //chest
			        screen = "storage"
				screenBonus[0] = x2
				screenBonus[1] = y2
			break;
		}
	}
	render()
}
function createParticles(minX, minY, maxX, maxY, type, amp, minRad, maxRad, minSpeed, maxSpeed, color, colorType, radiusMin, radiusMax, minAmount, maxAmount, minLife, maxLife, frictionMin, frictionMax) {
	var i = Math.round(randomRange(minAmount, maxAmount))
	while (i>0) {
		var rad = randomRange(minRad,maxRad)
		var speed = randomRange(minSpeed,maxSpeed)
	        particles.push(JSON.parse(JSON.stringify({
	        	x: randomRange(minX, maxX),
	        	y: randomRange(minY, maxY),
	        	dx: Math.sin(rad)*speed,
	        	dy: Math.cos(rad)*speed,
	        	type: type,
			amp: amp,
	        	radius: randomRange(radiusMin, radiusMax),
			life: Math.round(randomRange(minLife, maxLife)),
			color: color,
			colorType: colorType,
			friction: randomRange(frictionMin, frictionMax),
	        })))
		i--
        }
}
function craftItems(recipe, amnt) {
        var slotToPlace = 0, a, b, c, d=true, amount = amnt || 1
	var amounts = Array(items.length).fill(0)
	var IndxOnInv = Array(items.length).fill(-1)
	var recipeToCraft = typeof recipe === "number" ? recipes[recipe] : recipe
	while (slotToPlace < player.stats.inventorySlots) {
		var b = inventory[slotToPlace][0]
                b == recipeToCraft[2][0] || b == 0 ? a = true : 0
		if(a)break;
		slotToPlace++
	}
	if(!a)return
	for (c in inventory) {
		if(c>34)break;
                amounts[inventory[c][0]] += inventory[c][1]
		IndxOnInv[inventory[c][0]] = c
	}
	for (b in recipeToCraft[0]) {
                d = d && (amounts[recipeToCraft[0][b][0]] >= recipeToCraft[0][b][1] * amount)
	}
	if(!d)return
	for (b in recipeToCraft[0]) {
                inventory[IndxOnInv[recipeToCraft[0][b][0]]][1] -= recipeToCraft[0][b][1] * amount
		inventory[IndxOnInv[recipeToCraft[0][b][0]]][1] == 0 ? inventory[IndxOnInv[recipeToCraft[0][b][0]]][0] = 0 : 0
	}
	inventory[slotToPlace][0] = recipeToCraft[2][0]
	inventory[slotToPlace][1] += recipeToCraft[2][1] * amount
}
function pickup(type) {
	var touched = -2 
	switch (type) {
		case "inventory":
			if (mousePos.y>=530&&mousePos.x<500&&mousePos.y<=590) {
                                if (mousePos.x%70-9>0) {
			                touched = Math.floor(mousePos.x/70)
		                }
	                }
		        if (mousePos.y>=95&&mousePos.x>=65&&(mousePos.y%70<15||mousePos.y%70>24)&&(mousePos.x+5)%70<60&&mousePos.x<=644&&mousePos.y<=444&&screen=="inventory") {
                                touched = Math.floor((mousePos.x-65)/70)+(4-Math.floor((mousePos.y-95)/70))*7
	                }
	                if((touched==-2||touched>=player.stats.inventorySlots)&&screen=="inventory") {
                                var rad = Math.atan2(mousePos.x-450,mousePos.y-330)
			        var speed = 0.18
			        if(out[0]){drops.push({
				        id: out[0],
				        x: player.pos[0]+0.5,
				        y: player.pos[1]+0.5,
				        dx: Math.sin(rad)*speed,
				        dy: Math.cos(rad)*speed,
				        friction: 0.97,
				        amount: out[1],
				        life: 19, 
			        })}
				out = [0,0]
			} else if (touched!==-2) {
                                var tempOut = inventory[touched].slice()
	                        inventory[touched] = out.slice()
	                        out = tempOut.slice() 
			}                       
		break;
		case "crafting":
                        if (mousePos.x>=100&&mousePos.x<=790&&mousePos.y>=95&&mousePos.y<=305) {
		                if ((mousePos.x-40)%70<60&&(mousePos.y-35)%70<60) {
			                touched = Math.floor((mousePos.x-100)/70) + Math.floor((mousePos.y-95)/70)*10
		                }
	                } else if (mousePos.x>=365&&mousePos.x<=405&&mousePos.y>=385&&mousePos.y<=425) {
				touched = -3
			} else if (mousePos.x>=495&&mousePos.x<=535&&mousePos.y>=385&&mousePos.y<=425) {
				touched = -4
			}
	                return touched
	 	break;
		case "storage":
			if (mousePos.x>=210&&mousePos.x<=690&&mousePos.y>=235&&mousePos.y<=365) {
                                if ((mousePos.x-150)%70<60&&(mousePos.y-175)%70<60) {
                                        touched = Math.floor((mousePos.x-210)/70) + Math.floor((mousePos.y-235)/70)*7
				}
			}
			return touched
		break;
	}
}
function updateTime() {
        hr += 0.002
	hr = hr.toFixed(4)
	hr %= 24
	if(!(hr*1000%500)&&hr<6)spawnEnemies()
	if (hr==0) day++
	diff = day+0.5
}
function updateInventory() {
	amounts=Array(items.length).fill(0),IndxOnInv=Array(items.length).fill(-1)
        for (c in inventory) {
	        if(c>34)break;
		if (inventory[c][1]>0) {
                        amounts[inventory[c][0]] += inventory[c][1]
		        IndxOnInv[inventory[c][0]] = c
		        unlocked[inventory[c][0]] = true
		} 
	}
        inventory = Array(45).fill([0,0]).map(copy)
	inventory.push([0,0,0,0])
	for (c in IndxOnInv) {
                if (IndxOnInv[c]>-1) {
			inventory[IndxOnInv[c]][0] = parseInt(c)
			inventory[IndxOnInv[c]][1] = amounts[c]
		}
	 }
}
function updateClick() {
	click[0] = click[1] != mouseDown[0] && mouseDown[0]==1
	click[1] = mouseDown[0]
}
function renderObjects() {
	ctx.clearRect(-900,-600,1800,1200)
        var x=0,p,q
        while (x<15) {
                var y=0	
	        while (y<10) {
			var x2 = x+player.pos[0]-7
			var y2 = y+player.pos[1]-5
                        if (x2<map[0].length&&x2>-1&&y2<map.length&&y2>-1) {
				//ctx.fillStyle="hsl("+ 
				//(220-(220*map[x2][y2]))
				//+",100%,"+15*(Math.cos(hr*Math.PI/12+Math.PI)+1.35)+"%)"
				var h = map[x2][y2]
				if (h< .1)ctx.fillStyle="hsl(192, 100%, 15%)"
	                        else if (h< .2)ctx.fillStyle="hsl(192, 100%, 30%)"
	                        else if (h< .3)ctx.fillStyle="hsl(192, 100%, 50%)"
	                        else if (h< .4)ctx.fillStyle="hsl(62 , 100%, 45%)"
	                        else if (h<.62)ctx.fillStyle="hsl(120, 100%, 30%)"
	                        else if (h<.71)ctx.fillStyle="hsl(120 ,100%, 15%)"
	                        else if (h<.75)ctx.fillStyle="hsl(30 ,   0%, 40%)"
	                        else ctx.fillStyle="hsl(0  ,   0%, 90%)"
				//var pxl = document.getElementById("canvas2").getContext("2d").getImageData(Math.trunc(map[x2][y2]*1000),0,1,1).data
				//ctx.fillStyle = "rgb("+pxl[0]+","+pxl[1]+","+pxl[2]+")"
				ctx.fillRect( x * 60 , y * 60  , 60 , 60)                             
			} else {
				ctx.fillStyle="black"
				ctx.fillRect( x * 60 , y * 60 , 60 , 60)  
			}                       
                        
			y++
		}
	        x++
        }
	var x=0
	while (x<15) {
                var y=0
	        while (y<10) {
			var x2 = x+player.pos[0]-7
			var y2 = y+player.pos[1]-5
                        if (x2<map[0].length&&x2>-1&&y2<map.length&&y2>-1) {
				if (objectMap[x2][y2][0]==25&&objectMap[x2][y2][3].storage==undefined) {
					objectMap[x2][y2][3].storage = JSON.parse(JSON.stringify(Array(7).fill([0,0])))
				} else if (objectMap[x2][y2][0]==26&&objectMap[x2][y2][3].storage==undefined) {
					objectMap[x2][y2][3].storage = JSON.parse(JSON.stringify(Array(14).fill([0,0])))
				}
				if (objectMap[x2][y2][0] > 0) {
                                        ctx.drawImage(sprite.object, (objectMap[x2][y2][0]-1)%5*60,Math.floor((objectMap[x2][y2][0]-1)/5)*60,60,60,x*60,y*60,60,60)
				}
				if (objectMap[x2][y2][0] > 0 && Math.abs(x-7)+Math.abs(y-5)<=5) {
                                        ctx.fillStyle = "#f00"; ctx.fillRect(x*60, y*60-10, 60, 4)
					ctx.fillStyle = "#0f0"; ctx.fillRect(x*60, y*60-10, 60*Math.max(0, objectMap[x2][y2][1]/objectMap[x2][y2][2]), 4)
				}                      
			}
			y++
		}
	        x++
        }
	for (x in enemies) {
		ctx.translate((enemies[x].x-player.pos[0]+7)*60+30,(enemies[x].y-player.pos[1]+5)*60+30)
		ctx.rotate(enemies[x].rotation)
		ctx.drawImage(sprite.enemies, enemies[x].id%5*60, Math.floor(enemies[x].id)/5*60, 60, 60, 
		-30,-30,60,60)
		ctx.setTransform(1,0,0,1,0,0)
		if(enemies[x].hp<=0)player.powerups.rubyPower += player.powerups.ruby
	        ctx.fillStyle = "#f00";ctx.fillRect((enemies[x].x-player.pos[0]+7)*60,(enemies[x].y-player.pos[1]+5)*60+10,60,5)
	        ctx.fillStyle = "#0f0";ctx.fillRect((enemies[x].x-player.pos[0]+7)*60,(enemies[x].y-player.pos[1]+5)*60+10,Math.max(0,enemies[x].hp/enemies[x].mhp*60),5)
	}
	enemies = enemies.filter(a => a.hp>0)
}
function renderBars() {
	//hp, stamina, armor, ... bar
	ctx.fillStyle="rgba(0,0,0,0.3)";ctx.fillRect(700,485,200,115)
	//hp bar red
	ctx.fillStyle="#b00";ctx.fillRect(710,495,180,25)
	//hp bar green
	ctx.fillStyle="#0b0";ctx.fillRect(710,495,Math.max(player.stats.hp/player.stats.mhp,0)*180,25)
	ctx.fillStyle="rgba(0,0,0,0.8)"
	//ctx.fillRect(710,495,180,25) //attack bar
	ctx.fillRect(710,530,180,25) //armor bar
	ctx.fillRect(710, 565, 180, 25) //stamina bar
	ctx.fillRect(0,520,500,80) //hotbar
	//attack bar 
	//ctx.fillStyle="#ff0" 
	//ctx.fillRect(710,495,Math.min(Math.max(0, player.attackCooldown/100*player.stats.attackSpeed), 1)*180,25)
	//stamina bar
	ctx.fillStyle="#0cc";ctx.fillRect(710,565,player.stats.stamina/5*9,25)
	ctx.fillStyle="#fff";ctx.font = "21px Roboto";ctx.textAlign = "center"
	//hp bar number
        ctx.fillText(Math.floor(player.stats.hp)+" / "+player.stats.mhp,800,510)
	//attack bar number
	//ctx.fillText(Math.ceil((100-player.attackCooldown)/player.stats.attackSpeed*items[inventory[holding][0]].atkSpeed)/50+"s",800,510)
	//armor bar
	ctx.fillStyle="#ddd"
	var dmgAfter = 100/(player.stats.defense+100)
	ctx.fillRect(710,530,Math.max(0,-Math.log10(dmgAfter)%1*180),25)
	ctx.fillStyle = "#fff"
	if(dmgAfter>0.0001)ctx.fillText((100-dmgAfter*100).toFixed(2)+"%",800,545)
	else ctx.fillText("1/"+(1/dmgAfter).toFixed(2),800,545)
	//ctx.fillText(player.stats.stamina.toFixed(0)+"%",800,580)
}
function renderScreen() {
	switch (screen) {
                case "inventory":
			ctx.fillStyle="#000000a0"
			ctx.fillRect(55, 85, 780, 360)
			//ctx.fillStyle="#442200"
			//ctx.fillRect(60, 90, 570, 350)
			//ctx.fillRect(635, 90, 195, 350)
		break;
		case "crafting":
			ctx.fillStyle="#000000a0";ctx.fillRect(90, 85, 710, 360)
			//ctx.fillStyle="#442200";ctx.fillRect(95, 90, 700, 350)
			var recipesToDisplay = [],k,l,m
			var recipesToIndex = []
			for (k in recipes) {
				var n = true,o = false
				for (m in recipes[k][0]) {
                                        if (!unlocked[recipes[k][0][m][0]]) {
						n = false
						break;
					}						     
				}
				for (l in recipes[k][1]) {
                                        if (recipes[k][1][l] == screenBonus[0]) {
					        o = true       
						break;
					}
				}
				if (n&&o) {
					recipesToDisplay.push(recipes[k])
					recipesToIndex.push(k*1)
				}
			} //get recipes to display
			for (k in recipesToDisplay) {
				var toDisplay = k*1+screenBonus[1]*30
				if (k>29||recipesToDisplay[toDisplay]==undefined) break;
				ctx.fillStyle = rarity_colors[items[recipesToDisplay[toDisplay][2][0]].rarity]
				ctx.fillRect(100+k%10*70, Math.floor(k/10)*70+95, 60, 60)
				ctx.drawImage(sprite.items, 
				recipesToDisplay[toDisplay][2][0]%5*60, Math.floor(recipesToDisplay[toDisplay][2][0]/5)*60
				, 60, 60, 100+k%10*70, Math.floor(k/10)*70+95, 60, 60)
			}
                        var itemsHave = Array(items.length).fill(0)                     
			for (k in inventory) {
				if(k==34)break;
                                itemsHave[inventory[k][0]] = inventory[k][1]
			}
			if (!recipesToDisplay.length) {
				ctx.fillStyle="#fff";ctx.fillText("You should get some resources...",445, 265)	
		        } else {	     
			        var q = pickup("crafting")
			        if (q>-2&&q+screenBonus[1]*30<recipesToDisplay.length) {
				        if (click[0]) {
                                                craftItems(recipesToIndex[q+screenBonus[1]*30])
				        }
					for (k in recipesToDisplay[q][0]) {
                                                ctx.fillStyle = rarity_colors[items[recipesToDisplay[q][0][k][0]].rarity]
						ctx.fillRect(100+70*k,305,60,60)
						ctx.drawImage(sprite.items, recipesToDisplay[q][0][k][0]%5*60, Math.floor(recipesToDisplay[q][0][k][0]/5)*60, 60, 60, 100+k*70, 305, 60, 60)
					        ctx.fillStyle = recipesToDisplay[q][0][k][1] /*amt needed*/ <= itemsHave[recipesToDisplay[q][0][k][0]] /*amt have*/ ? "#0f0" : "#f00"
						ctx.fillText(recipesToDisplay[q][0][k][1],130+70*k,370)
					}
			        } else if (q==-3&&click[0]) {
                                        screenBonus[1]-- //<
				} else if (q==-4&click[0]) {
					screenBonus[1]++ //>
				}
				if(screenBonus[1]>=0)screenBonus[1] %= Math.ceil(recipesToDisplay.length/30)
				else screenBonus[1] = Math.ceil(recipesToDisplay.length/30)-1
			        ctx.font = "22px Roboto"
				ctx.textAlign = "center"
				ctx.fillStyle = "#fff"
				ctx.fillText("Page "+(screenBonus[1]+1), 450, 405)
				//ctx.fillText(10**screenBonus[2], 730, 405)
				ctx.fillStyle = "#000"
				ctx.fillRect(365,385,40,40);ctx.fillRect(495,385,40,40)
				//ctx.fillRect(605,385,40,40);ctx.fillRect(735,385,40,40)
				ctx.fillStyle = "#fff"
				ctx.fillRect(370,390,30,30);ctx.fillRect(500,390,30,30)
				//ctx.fillRect(610,390,30,30);ctx.fillRect(740,390,30,30)
				ctx.fillStyle="#000"
				ctx.font = "28px Roboto"
				ctx.fillText("<",385,407);ctx.fillText(">",515,407)
				//ctx.fillText("-",625,407);ctx.fillText("+",755,407)
		        }                 
		break;
		case "storage":
                        ctx.fillStyle="#000000a0"
			ctx.fillRect(200,225,500,150) //draw the tab itself
			var a
			for (a in objectMap[screenBonus[0]][screenBonus[1]][3].storage) {
				var item = objectMap[screenBonus[0]][screenBonus[1]][3].storage[a]
				ctx.fillStyle = rarity_colors[items[item[0]].rarity]
				ctx.fillRect(a%7*70+210,Math.floor(a/7)*70+235,60,60)
				ctx.drawImage(sprite.items, item[0]%5*60, Math.floor(item[0]/5)*60, 60, 60, a%7*70+210, Math.floor(a/7)*70+235, 60, 60)
			        ctx.fillStyle = "#fff";ctx.textAlign="center"
				if(item[0])ctx.fillText(item[1], a%7*70+240,Math.floor(a/7)*70+300)
				var touch = pickup("storage")
				if (click[0]&&touch!==-2) {
					var tempOut = objectMap[screenBonus[0]][screenBonus[1]][3].storage[touch].slice()
					objectMap[screenBonus[0]][screenBonus[1]][3].storage[touch] = out.slice()
	                                out = tempOut.slice()
				}
			}
		break;
	}
}
function build() {
	var builds =  [2 ,3 ,4 ,14,15,16,29,30,31,39,40,42,50,51,52]
	var objects = [16,14,15,17,18,21,19,20,22,23,24,25,27,28,26]
	var index = builds.indexOf(inventory[holding][0])
	if (index!==-1) {
		var indexToDraw = objects[index]-1
		var tile = [Math.floor(mousePos.x/60),Math.floor(mousePos.y/60)]
		var x2 = tile[0]-7+player.pos[0]
		var y2 = tile[1]-5+player.pos[1]
		ctx.drawImage(sprite.object,indexToDraw%5*60,Math.floor(indexToDraw/5)*60,60,60,tile[0]*60,tile[1]*60,60,60)
	        ctx.fillStyle = "hsla("+ (220-(220*map[x2][y2]))+",100%,"+15*(Math.cos(hr*Math.PI/12+Math.PI)+1.35)+"%,0.3)"
	        ctx.fillRect(tile[0]*60,tile[1]*60,60,60)
		ctx.fillStyle = (objectMap[x2][y2][0] == 0 &&map[x2][y2]>0.3)? "#0000" : "rgba(255,0,0,0.5)"
	        ctx.fillRect(tile[0]*60,tile[1]*60,60,60) //display transparent version of object
		if (mouseDown[2]) {
                        if (objectMap[x2][y2][0] == 0&&map[x2][y2]>0.3) {
                                objectMap[x2][y2] = [objects[index], objectHP[objects[index]], objectHP[objects[index]], {}]
				inventory[holding][1]--
			} //only place if target is nothing or high
		} //place object
	}
}
function showDetails() {
	var touched = -2
        if (mousePos.y>=530&&mousePos.x<500&&mousePos.y<=590) {
                if (mousePos.x%70-9>0) {
			touched = Math.floor(mousePos.x/70)
		}
	} else if (mousePos.y>=95&&mousePos.x>=65&&(mousePos.y%70<15||mousePos.y%70>24)&&(mousePos.x+5)%70<60&&mousePos.x<=644&&mousePos.y<=444&&screen=="inventory") {
                touched = Math.floor((mousePos.x-65)/70)+(4-Math.floor((mousePos.y-95)/70))*7
	}
	if(touched!==-2&&touched<player.stats.inventorySlots&&screen=="inventory") {
                ctx.fillStyle = rarity_colors[items[inventory[touched][0]].rarity]
		ctx.fillRect(640, 95, 60, 60)
		ctx.drawImage(sprite.items, 
		inventory[touched][0]%5*60, Math.floor(inventory[touched][0]/5)*60
		, 60, 60, 640, 95, 60, 60)
		ctx.fillStyle = "#fff"
		ctx.font = Math.floor(240/(items[inventory[touched][0]].name.length))+"px Roboto"
		ctx.fillText(items[inventory[touched][0]].name,765,125)
		ctx.font = "18px Roboto"
		ctx.textAlign = "left"
		wrapText("Damage: "+items[inventory[touched][0]].minDamage+" - "+items[inventory[touched][0]].maxDamage, 640, 170, 185, 17)
	        ctx.fillText("Rarity:", 640, 190, 185, 17)	
		ctx.fillStyle=rarity_colors[items[inventory[touched][0]].rarity];ctx.fillText(items[inventory[touched][0]].rarity.toUpperCase(), 694, 190);ctx.fillStyle="#fff"      
		wrapText("Description: "+items[inventory[touched][0]].desc, 640, 210, 185, 17)
	}
}
function renderCursor() {
	ctx.fillStyle = "#fff9"
        ctx.beginPath()
	ctx.arc(mousePos.x,mousePos.y,4,0,7)
	ctx.fill()
	ctx.closePath()
	ctx.fillStyle="#0009";ctx.fillRect(mousePos.x-18,mousePos.y+8,36,6)
	ctx.fillStyle="#fff9"; ctx.fillRect(mousePos.x-18,mousePos.y+8,Math.min(36,Math.max(0,player.attackCooldown/25*9)),6)
}
function renderInventory() {
	for (q in inventory) {
		if(q >= 35) break;
		//ctx.drawImage(sprite.rick, inventory[p][0]%2*60, Math.floor(inventory[p][0]/2)*60, 60, 60, 10+70*p, 530, 60, 60)
                if (q < 7) {
			ctx.fillStyle = rarity_colors[items[inventory[q][0]].rarity]
			ctx.fillRect(10+70*q, 530, 60, 60)
		        ctx.drawImage(sprite.items, inventory[q][0]%5*60, Math.floor( inventory[q][0]/5 )*60, 60, 60, 10+70*q, 530, 60, 60)
		        ctx.fillStyle = "rgba(0, 0, 0, 0.25)"
			if (q==holding) ctx.fillRect(70*q+10, 530, 60, 60)       
			if (inventory[q][0]) {
			        ctx.fillStyle = "#fff"
			        ctx.fillText(inventory[q][1], 40+70*q, 593)
				//10+70*q, 530
		        }  
	        } 
		if (screen=="inventory") {
			if (q > Math.min(player.stats.inventorySlots,45)-1) {
				//ctx.fillRect( q%9*70+100, 375-Math.floor(q/9)*70, 60, 60)
			} else {
				ctx.fillStyle = rarity_colors[items[inventory[q][0]].rarity]
				ctx.fillRect(q%7*70+65, 375-Math.floor(q/7)*70, 60, 60)
				ctx.drawImage(sprite.items, 
				inventory[q][0]%5*60, Math.floor(inventory[q][0]/5)*60
				, 60, 60, q%7*70+65, 375-Math.floor(q/7)*70, 60, 60)
				ctx.fillStyle = "rgba(0, 0, 0, 0.25)"
				if (q==holding) ctx.fillRect(q%7*70+65, 375-Math.floor(q/7)*70, 60, 60)
				ctx.fillStyle = "#fff"
				if(inventory[q][0])ctx.fillText(inventory[q][1], q%7*70+95, 438-Math.floor(q/7)*70)
			}
		}
	}
	if (out[0]!=0) {
		ctx.drawImage(sprite.items, out[0]%5*60, Math.floor( out[0]/5 )*60, 60, 60, mousePos.x-30, mousePos.y-30, 60, 60)
	        ctx.fillStyle = "#fff"
	        ctx.fillText(out[1], mousePos.x, mousePos.y+30)
	}
	showDetails()
}
function calcPower(n) {
	//var b=0,n=n||0,str=typeof str === "number"?str:1
	//switch (type) {
	//	case 0:var a=0;while(a++<n){b+=(1+str)/(a+str)};break; //diminishing returns?
	//	case 1:b=n*str;break; //linear
 //               case 2:b=n**(str+.1)+calcPower(1,n,str*.4)+str*.6;break;   //quadratics/polynomials
		//case 3:b=n>0?(str+.008)**n:0;break; //exponential
	//}
	//return b
	return Math.log(n)/Math.log(1.6)
}
function spawnVein(id, times, size) {
	while (times--) {
		var X = Math.floor(random.nextFloat()*map.length) 
	        var Y = Math.floor(random.nextFloat()*map.length)
		while (map[X][Y]<.32) {
                        X = Math.floor(random.nextFloat()*map.length) 
	                Y = Math.floor(random.nextFloat()*map.length)
		}
		var x = -size
		while (x<=size) {
			var y = -size
			while (y<=size) {
				var chance = Math.sqrt(x**2+y**2)/size
				var x2 = Math.max(Math.min(map.length-1,x+X),0)
				var y2 = Math.max(Math.min(map.length-1,y+Y),0)
				if (chance<(random.nextFloat())&&map[x2][y2]>.32&&random.nextFloat()<.2) {
					objectMap[x2][y2] = [id, objectHP[id], objectHP[id], {}]
				}
				y++
			}
			x++
		}
	}
}
function spawnEnemies() {
	var spwnPower = Math.round((day+1)*5*Math.random())
	while (spwnPower>=2) {
		if (spwnPower>=2) {
			spwnPower-=2
			var spawnPos = [Math.floor(Math.random()*70)-35+player.pos[0],Math.floor(Math.random()*70)-35+player.pos[1]]
		        var a = 20       
			while (objectMap[spawnPos[0]][spawnPos[1]][0]&&a-->0) {
				spawnPos = [Math.floor(Math.random()*70)-35+player.pos[0],Math.floor(Math.random()*70)-35+player.pos[1]]
			        console.log(spawnPos)
				console.log(objectMap[spawnPos[0]][spawnPos[1]])
			}
			if (a>0) {
				enemies.push({
                                        attackInterval: 100,
					moveInterval:40,
					rotation: 0,
					cooldown: 0,
					moveCooldown: 0,
					id: 0,
					hp: 35*diff,
					mhp: 35*diff,
					minDamage:4*diff,
					maxDamage:5*diff,
					tick: function() {
						this.cooldown++
						this.moveCooldown++
						this.rotation = -Math.atan2(this.x-player.pos[0],this.y-player.pos[1])
						if (this.moveInterval<=this.moveCooldown) {
                                                        this.move()
							this.moveCooldown = 0
						}
						if (this.attackInterval<=this.cooldown) {
							this.attack()
							this.cooldown = 0
						}
					},
					x: spawnPos[0],
					y: spawnPos[1],
					attack: function() {
						var xAttack = this.x+0.5+51/60*Math.sin(this.rotation)
						var yAttack = this.y+0.5-51/60*Math.cos(this.rotation)
                                                var x=-10
						while (x<=10) {
							var y=-10
							while (y<=10) {
								var coll = circleCollision(xAttack,yAttack,0.5,this.x+x+0.5,this.y+y+0.5,Math.SQRT1_2)
								if (coll) {
									var damageDealt = Math.round(randomRange(this.minDamage,this.maxDamage))
									objectMap[x+this.x][y+this.y][1] -= damageDealt
                                                                        if(objectMap[x+this.x][y+this.y][0]){texts.push({
                                                                                x: x+0.5,
					                                        y: y+0.5,
					                                        dx: Math.random()/5-0.1,
					                                        dy: 0.15,
					                                        fadeSpeed: 8,
					                                        color: [0, 0, 0, 255],
					                                        content: damageDealt,
							                })}
								}
								y++
							}
							x++
						}
						if (circleCollision(xAttack,yAttack,0.5,player.pos[0]+0.5,player.pos[1]+0.5,Math.SQRT1_2)) {
							var dmgDealt = Math.round(randomRange(this.minDamage,this.maxDamage)) * 100 / (player.stats.defense+100)
							player.stats.hp = Math.max(0, player.stats.hp-dmgDealt)
							texts.push({
                                                                x: player.pos[0]+0.5,
					                        y: player.pos[1]+0.5,
					                        dx: Math.random()/5-0.1,
					                        dy: 0.15,
					                        fadeSpeed: 8,
					                        color: [255, 255, 255, 255],
					                        content: damageDealt,
							})
							var particleRad = Math.atan2(this.x-player.pos[0],this.y-player.pos[1])+Math.PI
							createParticles(0.45+player.pos[0],0.45+player.pos[1],0.55+player.pos[0],0.55+player.pos[1],[1,2],[0.005,10],-0.7+particleRad,0.7+particleRad,0.06,0.1,[255,0,0,255],"rgb",0.1,0.13,3,5,40,50,0.97,0.98)
						        createParticles(0.45+player.pos[0],0.45+player.pos[1],0.55+player.pos[0],0.55+player.pos[1],[1,2],[0.005,10],-0.7+particleRad,0.7+particleRad,0.06,0.1,[200,0,0,255],"rgb",0.1,0.13,3,5,40,50,0.97,0.98)
						}
					},
					move: function() {
                                                var dist = []
						dist[0] = objectMap[this.x+1][this.y][0]?Infinity:(this.x+1-player.pos[0])**2+(this.y-player.pos[1])**2
						dist[1] = objectMap[this.x-1][this.y][0]?Infinity:(this.x-1-player.pos[0])**2+(this.y-player.pos[1])**2
                                                dist[2] = objectMap[this.x][this.y+1][0]?Infinity:(this.x-player.pos[0])**2+(this.y+1-player.pos[1])**2
						dist[3] = objectMap[this.x][this.y-1][0]?Infinity:(this.x-player.pos[0])**2+(this.y-1-player.pos[1])**2
						var index = 0,a,min=Infinity
						var m = [[1,0],[-1,0],[0,1],[0,-1]]
						for (a in dist) {
							if (dist[a]<min) {
								index = a*1
								min = dist[a]
							}
						}					        
						var tempX = this.x
						var tempY = this.y
						tempX += m[index][0]
						tempY += m[index][1]
						var collidedWithMobs = false
						for (a in enemies) {
                                                        if (enemies[a].x == tempX && enemies[a].y == tempY) {
                                                                collidedWithMobs = true
								break;
							}
						}
						if (!objectMap[tempX][tempY][0]&&!(tempX==player.pos[0]&&tempY==player.pos[1])&&!collidedWithMobs) {
                                                        this.x = tempX
							this.y = tempY
						} 
					},
				})
			}
		}
	}
}
function levelUp() {
	while (player.exp>=(player.level+1)**2*500) {
                player.level++
		player.exp-=player.level**2*500
		var a = Object.keys(player.powerups)
		var b = a.length*Math.random()<<0
		while (a[b]=="berserkActive"||a[b]=="rubyPower") {
			b = a.length*Math.random()<<0
		}
		player.powerups[a[b]]
	}
}
//non gameplay functions 
function overflowRange(min, max, n) {
   var size = max-min+1
   if (n>max) return min+(n-max)%size
   else if (n<min) return max+(n-min)%size
   else return n 
}
function repeatFunc(func,times) {
	while (times--) {
		func()
	}
}
function Load() { //creates the map on load
    map = baseMap(width,height)
    intv = setInterval(maps,20) //useless
    //heatMap = baseMap(width,height)
     /*81 == update times*/
    var ai
    /* for(ai in Array(8).fill(0)){
        createEntity(Math.random()*400+100,Math.random()*400+100, 40 , "phsads")
        createEntity(Math.random()*400+100,Math.random()*400+100, 220 , "phsads2")
    } */
}
function wrapText(text, x, y, maxWidth, lineHeight) {
        var words = text.split(' ');
        var line = '';

        for (var n = 0; n < words.length; n++) {
                var testLine = line + words[n] + ' ';
                var metrics = ctx.measureText(testLine);
                var testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                        ctx.fillText(line, x, y);
                        line = words[n] + ' ';
                        y += lineHeight;
                } else {
                        line = testLine;
                }
        }
        ctx.fillText(line, x, y);
}
document.body.onmousedown = function(evt) { 
  mouseDown[evt.button] = 1;
}
canvas.oncontextmenu = function(e) { e.preventDefault(); e.stopPropagation(); }
document.body.onmouseup = function(evt) {
  mouseDown[evt.button] = 0;
}
function circleCollision(x1,y1,r1,x2,y2,r2) {return !((x1-x2)**2+(y1-y2)**2>(r1+r2)**2)}
function weighted_random(a) {
	//a = {"2":weight}
	var b,c=0,d
	for (b in a) {
                c += a[b]
	}
	d = Math.random()*c
	for (b in a) {
		if (d < a[b]) {
			return b
		}
		d -= a[b]
	}
}
function getMousePos(event) {
    var rect = canvas.getBoundingClientRect();
    mousePos = {
        x: event.clientX - rect.left,
        y: event.clientY - rect.top
    };
} //stolem code boo boo boo boo boo boo
function randomRange(min, max) {return Math.random()*(max-min)+min}
function format(a) {
    if (a<=1000) return a
    var b = ["K","M","B","T","Qa","Qi","Sx","Sp","Oc"]
    var c = Math.floor(Math.log10(a)/3)
    return (a/1000**c).toFixed(2) + b[c-1]
}
//map generation
function random2(a) { //random function
    var r=[seed],h=0
    while (h<60) {
        h++
        r[h] = ( (a**1.1+seed**0.7-7*a+21)*r[h-1] )%1
    }
    return r[60]
}
function RNG(seed) {
  // LCG using GCC's constants
  this.m = random2(random2(seed))*(2**31)
  this.a = random2(random2(seed))*(2**15)
  this.c = random2(random2(seed))*(2**12)

  this.state = seed ? seed : Math.floor(Math.random() * (this.m - 1));
  this.nextInt = function() {
  this.state = (random2(this.a)*2**15 * this.state + this.c) % this.m;
  return this.state;
  }
  this.nextFloat = function() {
  // returns in range [0,1]
  return this.nextInt() / (this.m - 1);
}
  this.nextRange = function(start, end) {
  // returns in range [start, end): including start, excluding end
  // can't modulu nextInt because of weak randomness in lower bits
  var rangeSize = end - start;
  var randomUnder1 = this.nextInt() / this.m;
  return start + Math.floor(randomUnder1 * rangeSize);
}
  this.choice = function(array) {
  return array[this.nextRange(0, array.length)];
}
}
var random = new RNG(seed)
var random3 = new RNG(2**24-seed)
function scaleConcat(array, factor) {
	let scaled = [];

	for(const row of array) {
		let x = [];

		for(const item of row)
			x = x.concat(Array(factor).fill(item));

		scaled = scaled.concat(Array(factor).fill(x));
	}

	return scaled.map(copy);
}
function baseMap(width,height) {
        return Array(height).fill(Array(width).fill(0)).map(copy)
} //create the baseMap (a.k.a) map with width and height but no value
function maps() {
    var y1=0
    while (y1<height) {
        var x1=0
        while (x1<width) {
            map[y1][x1] += random.nextFloat()-0.5 //add a random value
	    map[y1][x1] += random3.nextFloat()/4-0.125
            max=Math.max(map[y1][x1],max);min=Math.min(map[y1][x1],min) //change the min max
            x1++
        }
        y1++
    }
    times++
    if(times%avg==0) {
        var tempMap = map.map(copy)
        var i,j
        for (i in map) {
            for (j in map[i]) {
                var neigh=[],k=-1
                while (k<=1) {
                    var l=-1
                    while (l<=1) {
			var aby = k+(i*1)
			var abx = l+(j*1)
                        if (aby<height&&abx<width&&aby>-1&&abx>-1) {
                              neigh.push(map[aby][abx])
			}
                        l++
                    }
                    k++
                }
                try{tempMap[i][j] = neigh.reduce((a,b) => a+b)/(neigh.length**(1-times/200))}
		catch{console.log(i,j)}
		max=Math.max(tempMap[i][j],max);min=Math.min(tempMap[i][j],min) //change the min max
            }
        } //avg things out
        map = tempMap
    }
    //heatMaps() //update heatmaps
    if (times>maxTimes){clearInterval(intv);normalize()}
}
function heatMaps() {
    var y2=0
    while (y2<height) {
        var x2=0
        while (x2<width) {
            heatMap[y2][x2] += random.nextFloat()-0.5 //same as height maps
            heatMax=Math.max(heatMap[y2][x2],heatMax);heatMin=Math.min(heatMap[y2][x2],heatMin)
            x2++
        }
        y2++
    }
    if(times%avg==0) {
        var tempHMap = heatMap.map(copy) //we copy the map and not make referecne senbfugeidfbhg
        var u,v
        for (u in heatMap) {
            for (v in heatMap[u]) {
                var neigh=[],w=-1
                while (w<=1) {
                    var x=-1
                    while (x<=1) {
			var aay = w+(u*1)
			var aax = x+(v*1)
                        if (aay<height&&aax<width&&aay>-1&&aax>-1) {
                                neigh.push(heatMap[aay][aax])
			}
                        x++
                    }
                    w++
                }
                var red = (a,b) => a+b
                tempHMap[u][v] = neigh.reduce(red)/(neigh.length**(1-times/200))
            }
        }
        heatMap = tempHMap 
    }
}
function normalize() {
        var y,z
        var i,j
	for (y in map) {
                for (z in map[y]) {
                        map[y][z] = (map[y][z]-min)/(max-min)
                }
        } //fuck efficiency
	var tempMap = map.map(copy)
	min = Infinity, max=-Infinity
	var pow = new RNG(seed+3).nextFloat()*1.5+0.5
	var halfMap = map.length/2
	var quarterMap = map.length/4
	for (i in map) {
		for (j in map[i]) {
			var mult = 1 - (Math.max(Math.abs(i-halfMap),Math.abs(j-halfMap),quarterMap)-quarterMap)/quarterMap
			tempMap[i][j] *= mult
			tempMap[i][j] = tempMap[i][j] ** pow
		}
	}
	map = tempMap.map(copy)
	map = scaleConcat(map, 4)
	var tempMap = map.map(copy)
	for (i in map) {
                for (j in map[i]) {
                        var neigh=[],k=-1
                        while (k<=1) {
                                var l=-1
                                while (l<=1) {
			                var aby = k+(i*1)
			                var abx = l+(j*1)
                                        if (aby<map.length&&abx<map.length&&aby>-1&&abx>-1) {
                                                neigh.push(map[aby][abx])
			                }
                                        l++
                                }
                                k++
                        }
                        tempMap[i][j] = neigh.reduce((a,b) => a+b)/neigh.length
                        min = Math.min(tempMap[i][j],min) ; max = Math.max(tempMap[i][j],max)
                }
        } //avg things out  
        map = tempMap.map(copy)
	map = scaleConcat(map, 2)
	player.pos[0] = Math.round(random.nextFloat()*(map.length-2))
        player.pos[1] = Math.round(random.nextFloat()*(map[0].length-2))
        while (map[player.pos[0]][player.pos[1]]<0.3) {
	        player.pos[0] = Math.floor(random.nextFloat()*(map.length-2))
	        player.pos[1] = Math.floor(random.nextFloat()*(map[0].length-2))
        }
	objectMap = JSON.parse(JSON.stringify(Array(map.length).fill(Array(map[0].length).fill([0,0,0,{}]))))  
	//[0] = id, [1] = hp, [2] = mhp, [3] = extra info      
	spawnVein(1,30,62) //balsa forest
	spawnVein(2,100,16) //stone thingy
	spawnVein(3,80,14) //copper
	spawnVein(4,80,12) //iron
	spawnVein(5,32,52) //maple forest
	spawnVein(6,70,12) //platinum
	spawnVein(7,70,10) //mithril
	spawnVein(8,30,52) //birch forest
	spawnVein(9,60,10) //adam
	spawnVein(10,60,8) //titan
	spawnVein(11,30,46) //pine
	spawnVein(12,50,8) //unob
	spawnVein(13,50,6) //uni
	terrainGradient = ctx.createLinearGradient(0,0,1000,0)
	terrainGradient.addColorStop(.1 ,"hsl(192, 100%, 15%)")
	terrainGradient.addColorStop(.2 ,"hsl(192, 100%, 30%)")
	terrainGradient.addColorStop(.3 ,"hsl(192, 100%, 50%)")
	terrainGradient.addColorStop(.4 ,"hsl(62 , 100%, 45%)")
	terrainGradient.addColorStop(.62,"hsl(120, 100%, 30%)")
	terrainGradient.addColorStop(.71,"hsl(120 ,100%, 15%)")
	terrainGradient.addColorStop(.75,"hsl(30 ,   0%, 40%)")
	terrainGradient.addColorStop(1  ,"hsl(0  ,   0%, 90%)")
	document.getElementById("canvas2").getContext("2d").fillStyle = terrainGradient
	document.getElementById("canvas2").getContext("2d").fillRect(0,0,1000,1)
}
var intv
var copy = a => {return a.slice(0)}
setInterval(update,20)
</script>
</html>